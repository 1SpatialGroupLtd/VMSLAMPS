%MACR _UT_JUMP_PLM
%JUMP .PLMS_'UT_PLMS'
.PLMS_1:
%ROUT 101 6
%ROUT 101 10 SELECT
%ROUT 101 10 UPD_ABS_DIST
%ROUT 101 10 FROM WELD_TABLE_'O_PIPE_ID
%ROUT 101 10 WHERE ORIG_WELD = 'UT_WELD
%ROUT 101 10 AND TAPE_NUM = 'UT_TAPE';
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%ELSE MESSAGE "Weld 'UT_WELD (Tape 'UT_TAPE') not found"
%JFAL .FAIL
%LET _REAL6 = 'DB_RESULT_VALUE1
%JUMP _UT_JUMP_ATTR
.PLMS_2:
%ROUT 101 6
%ROUT 101 10 SELECT
%ROUT 101 10 UPD_ABS_DIST
%ROUT 101 10 FROM WELD_TABLE_'O_PIPE_ID
%ROUT 101 10 WHERE ORIG_ABS_DIST
%ROUT 101 10 >= 'UT_DIST'
%ROUT 101 10 AND TAPE_NUM = 'UT_TAPE'
%ROUT 101 10 ORDER BY ORIG_ABS_DIST ASC;
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%ELSE MESSAGE "Distance 'UT_DIST' (Tape 'UT_TAPE') is out of range"
%JFAL .FAIL
%LET _REAL6 = 'DB_RESULT_VALUE1
%JUMP _UT_JUMP_ATTR
.PLMS_3:
%ROUT 101 6
%ROUT 101 10 SELECT
%ROUT 101 10 UPD_ABS_DIST
%ROUT 101 10 FROM WELD_TABLE_'O_PIPE_ID
%ROUT 101 10 WHERE UPD_WELD = 'UT_WELD;
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%ELSE MESSAGE "Weld 'UT_WELD not found"
%JFAL .FAIL
%LET _REAL6 = 'DB_RESULT_VALUE1
%JUMP _UT_JUMP_ATTR
.PLMS_4:
%LET _REAL6 = 'UT_DIST
%JUMP _UT_JUMP_ATTR
.PLMS_5:
%ROUT 101 6
%ROUT 101 10 SELECT
%ROUT 101 10 MAX(UPD_ABS_DIST)
%ROUT 101 10 FROM WELD_TABLE_'O_PIPE_ID W,
%ROUT 101 10 FTR_TABLE_'O_PIPE_ID F
%ROUT 101 10 WHERE F.MAP_ID = 'O_CUR_MAP_ID AND
%ROUT 101 10 F.FTR_ID = W.FTR_ID;
%TEST DB_STATUS
%ELSE % MESSAGE Error obtaining distance
%JFAL .FAIL
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%ELSE % MESSAGE End of Strip Map is not tied in
%JFAL .FAIL
%LET _REAL6 = 'DB_RESULT_VALUE1
%TEST _REAL6 > 0.0
%JTRU _UT_JUMP_ATTR
%ELSE % PING
%ELSE % MESSAGE No Tied-In points found
%JFAL .FAIL
.PLMS_6:
%ROUT 101 6
%ROUT 101 10 SELECT
%ROUT 101 10 MIN(UPD_ABS_DIST)
%ROUT 101 10 FROM WELD_TABLE_'O_PIPE_ID W,
%ROUT 101 10 FTR_TABLE_'O_PIPE_ID F
%ROUT 101 10 WHERE F.MAP_ID = 'O_CUR_MAP_ID AND
%ROUT 101 10 F.FTR_ID = W.FTR_ID;
%TEST DB_STATUS
%ELSE % MESSAGE Error obtaining distance
%JFAL .FAIL
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%ELSE % MESSAGE Start of Strip Map is not tied in
%JFAL .FAIL
%LET _REAL6 = 'DB_RESULT_VALUE1
%TEST _REAL6 > 0.0
%JTRU _UT_JUMP_ATTR
%ELSE % PING
%ELSE % MESSAGE No Tied-In points found
%JFAL .FAIL
.FAIL:
%ENDM
%MACR _UT_JUMP_ATTR
%TEST DEBUG
%THEN %MESSAGE JUMP PLM started at '$DATETIME'
%LET L = 0
%LET _INT7 = 0
%LET _CHAR9 = " "
%LET _CHAR10 = " "
%FILE SELECT 1
%FILE WRITE ADD LOCK
%FILE WRITE LIST CLEAR PLM_DISP
%FILE WRITE REMOVE WELD_WINDOW
%FILE WRITE TOGGLE OFF OVER_WINDOW
%LET O_WIND_ON = N
%LET W = 0
%LET STRING = "0.0"
%LET _INT1 = 0
%LET _INT5 = 1
%ROUT 101 6
%ROUT 101 10 SELECT
%ROUT 101 10 TAPE_NUM,
%ROUT 101 10 ORIG_WELD,
%ROUT 101 10 UPD_ABS_DIST,
%ROUT 101 10 ORIG_ABS_DIST,
%ROUT 101 10 UPD_WELD,
%ROUT 101 10 FTR_ID,
%ROUT 101 10 COMMENT,
%ROUT 101 10 FTR_TYPE,
%ROUT 101 10 STACK_SEQ
%ROUT 101 10 FROM
%ROUT 101 10 WELD_TABLE_'O_PIPE_ID
%ROUT 101 10 WHERE
%ROUT 101 10 UPD_ABS_DIST BETWEEN
%ROUT 101 10 ('_REAL6 - 'UT_RANGE)
%ROUT 101 10 AND ('_REAL6 + 'UT_RANGE)
%TEST O_ORDER = 0
%THEN % ROUTINE 101 10 ORDER BY STACK_SEQ,ORIG_WELD,UPD_ABS_DIST,FTR_ID;
%TEST O_ORDER = 1
%THEN ROUTINE 101 10 ORDER BY UPD_ABS_DIST,FTR_TYPE,FTR_ID;
%TEST O_ORDER = 2
%THEN % ROUTINE 101 10 ORDER BY STACK_SEQ,ORIG_WELD,FTR_TYPE,UPD_ABS_DIST,FTR_ID;
%TEST DB_STATUS
%JFAL _OLIGS_ERROR "Error selecting weld entries"
%ROUT 101 17 J '_INT5
%LET UT_PRE_ABS = 'DB_RESULT_VALUE3'
%ROUT 101 17 J '_INT5
%TEST DB_STATUS
%JFAL .END
%LET L = 1
.RETRIEVE:
%TEST DB_STATUS
%JFAL .END
%LET UT_STKS = 'DB_RESULT_VALUE9'
%LET UT_FTID = 'DB_RESULT_VALUE6
%LET UT_JMP_ABS = 'DB_RESULT_VALUE3'
%TEST DB_RESULT_NULL4
%JFAL .PAD_MAGTAPE
%LET UT_ORIGD = -1000
%LET _CHAR6 = "        "
%LET _CHAR2 = "       "
%LET _CHAR3 = "     "
%JUMP .MAGTAPE
.PAD_MAGTAPE:
%ROUT 101 68 1 2 'DB_RESULT_VALUE4
%ASK STRING PAD 8 "'SIG_STR"
%LET _CHAR6 = "'$ASK_CHAR1"
%LET UT_ORIGD = 'DB_RESULT_VALUE4'
.MAGTAPE:
%LET _INT10 = 'DB_RESULT_VALUE1'
%ASK STRING PAD 7 "'DB_RESULT_VALUE1"
%LET _CHAR2 = "'$ASK_CHAR1"
%ASK STRING PAD 5 "'DB_RESULT_VALUE2"
%LET _CHAR3 = "'$ASK_CHAR1"
%LET _INT8 = '_CHAR3
%ASK STRING PAD 6 "'DB_RESULT_VALUE5"
%LET _CHAR4 = "'$ASK_CHAR1"
%LET _INT9 = '_CHAR4
%LET _CHAR5 = "'DB_RESULT_VALUE7"
%ROUT 101 68 1 2 'DB_RESULT_VALUE3
%ASK STRING PAD 7 "'SIG_STR"
%LET _CHAR7 = "'$ASK_CHAR1"
%LET _REAL1 = '_CHAR7
%LET X = '_CHAR7 - 'STRING
%TEST _INT1 = 0
%THEN LET X = 0
%THEN LET _INT1 = 1
%TEST DB_RESULT_VALUE8 = 0
%JFAL .FEATURE
%TEST DB_RESULT_NULL5
%JFAL .WELD_NUMBER
%LET _CHAR4 = "      "
%LET _CHAR7 = "       "
%LET _CHAR8 = "       "
%JTRU .WELD_ENTRY
.WELD_NUMBER:
%LET STRING = 'SIG_STR
%ROUT 101 68 1 2 'X
%ASK STRING PAD 7 "'SIG_STR'"
%LET _CHAR8 = "'$ASK_CHAR1"
%JUMP .WELD_ENTRY
.FEATURE:
%TEST DB_RESULT_NULL5
%JFAL .WF_NOT_NULL
%LET _INT9 = 0
%LET _CHAR2 = "       "
%LET _CHAR3 = "     "
%LET _CHAR4 = "      "
.WF_NOT_NULL:
%ROUT 101 68 1 2 'X
%ASK STRING PAD 7 "'SIG_STR'"
%LET _CHAR8 = "'$ASK_CHAR1"
%TEST DB_RESULT_VALUE8 = 2
%JFAL .FTR_CHECK
%ROUT 101 8 2
%ROUT 101 10 select    AZIMUTH,
%ROUT 101 10           SITU
%ROUT 101 10 from      DFCT_TABLE_'O_PIPE_ID'
%ROUT 101 10 where     FTR_ID = 'DB_RESULT_VALUE6';
%TEST DB_STATUS
%JFAL _OLIGS_ERROR "SQL error in SELECT AZIMUTH,SITU from DFCT_TABLE_..."
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%ELSE MESSAGE WARNING no defect details found in dfct_table for ftr_id 'db_result_value6
%JFAL .DFCT_ENTRY
%TEST DB_RESULT_NULL1
%AND DB_RESULT_NULL2
%THEN % LET UT_DFC_DSC = " "
%JTRU .DFCT_ENTRY
%LET UT_DFC_DSC = "- 'DB_RESULT_VALUE2'"
%TEST DB_RESULT_NULL1
%JTRU .DFCT_ENTRY
%ASK STRING EXTRACT 1 2 'DB_RESULT_VALUE1
%LET CH = "'$ASK_CHAR1'-"
%ASK STRING EXTRACT 3 4 'DB_RESULT_VALUE1
%LET CH = 'CH''$ASK_CHAR1
%TEST DB_RESULT_NULL2
%THEN % LET UT_DFC_DSC = "- 'CH"
%ELSE % LET UT_DFC_DSC = "'UT_DFC_DSC' - 'CH'"
%JUMP .DFCT_ENTRY
.FTR_CHECK:
%ROUT 101 8 2
%ROUT 101 10 SELECT
%ROUT 101 10 FTR_CODE,
%ROUT 101 10 FTR_DESC_ONE,
%ROUT 101 10 FTR_DESC_TWO
%ROUT 101 10 FROM FTR_TABLE_'O_PIPE_ID
%ROUT 101 10 WHERE FTR_ID = 'DB_RESULT_VALUE6;
%TEST DB_STATUS
%JFAL _OLIGS_ERROR "SQL error in SELECT FTR_CODE,FTR_DESC_ONE,FTR_DESC_TWO FROM FTR_TABLE_..."
%ROUT 101 17 J 'DB_ID
%TEST DB_STATUS
%JFAL _OLIGS_ERROR "No Feature Record found for Feature 'DB_RESULT_VALUE6 in FTR_TABLE_'O_PIPE_ID"
%TEST DB_RESULT_VALUE1 = 999
%THEN %LET UT_PRE_ABS = 'UT_JMP_ABS'
%THEN %ROUTINE 101 17 J '_INT5
%JTRU .RETRIEVE
%TEST _INT7 = 'DB_RESULT_VALUE1
%AND _CHAR9 = 'DB_RESULT_VALUE2
%AND _CHAR10 = 'DB_RESULT_VALUE3
%LET _INT7 = 'DB_RESULT_VALUE1
%LET _CHAR9 = 'DB_RESULT_VALUE2
%LET _CHAR10 = 'DB_RESULT_VALUE3
%JTRU .FTR_ENTRY
%TEST DB_RESULT_VALUE1 >39
AND DB_RESULT_VALUE1 < 46
%THEN _O_TRANS_FC 'DB_RESULT_VALUE1 NULL 'DB_RESULT_VALUE3
%ELSE _O_TRANS_FC 'DB_RESULT_VALUE1 'DB_RESULT_VALUE2 'DB_RESULT_VALUE3
.FTR_ENTRY:
%LET _CHAR1 =  "'_CHAR2 '_CHAR3 '_CHAR6 '_CHAR4 '_CHAR7 '_CHAR8 '_CHAR5 'O_DESC_B"
%ASK STRING EXTRACT 1 80 "'_CHAR1"
%LET _CHAR1 = "'$ASK_CHAR1'"
.FTR_WRITE:
%ROUT 101 17 J '_INT5
%FILE SELECT 1
%FILE WRITE LIST ADD "'_CHAR1" "SEND _UT_JUMP_HLT 1 '_REAL1 'UT_FTID '_INT10 '_INT8 '_INT9 ""'_CHAR5'"" '_CHAR8' 'UT_JMP_ABS' 'UT_PRE_ABS' 'UT_STKS' 'UT_ORIGD' 'DB_RESULT_VALUE3' 'DB_RESULT_VALUE5'" PLM_DISP
%LET UT_PRE_ABS = 'UT_JMP_ABS'
%JUMP .RETRIEVE
.WELD_ENTRY:
%ROUT 101 17 J '_INT5
%LET _CHAR1 = "'_CHAR2 '_CHAR3 '_CHAR6 '_CHAR4 '_CHAR7 '_CHAR8 '_CHAR5'"
%FILE SELECT 1
%FILE WRITE LIST ADD "'_CHAR1" "SEND _UT_JUMP_HLT 0 '_REAL1 'UT_FTID '_INT10 '_INT8 '_INT9 ""'_CHAR5'"" '_CHAR8' 'UT_JMP_ABS' 'UT_PRE_ABS' 'UT_STKS' 'UT_ORIGD' 'DB_RESULT_VALUE3' 'DB_RESULT_VALUE5'" PLM_DISP
%LET UT_PRE_ABS = 'UT_JMP_ABS'
%JUMP .RETRIEVE
.DFCT_ENTRY:
%ROUT 101 17 J '_INT5
%LET _CHAR1 = "'_CHAR2 '_CHAR3 '_CHAR6 '_CHAR4 '_CHAR7 '_CHAR8 '_CHAR5' 'UT_DFC_DSC'"
%ASK STRING EXTRACT 1 80 "'_CHAR1"
%LET _CHAR1 = "'$ASK_CHAR1"
.DFCT_WRITE:
%FILE WRITE LIST ADD "'_CHAR1" "SEND _UT_JUMP_HLT 2 '_REAL1 'UT_FTID '_INT10 '_INT8 '_INT9 ""'_CHAR5'"" '_CHAR8' 'UT_JMP_ABS' 'UT_PRE_ABS' 'UT_STKS' 'UT_ORIGD' 'DB_RESULT_VALUE3' 'DB_RESULT_VALUE5'" PLM_DISP
%LET UT_PRE_ABS = 'UT_JMP_ABS'
%JUMP .RETRIEVE
.END:
%TEST DEBUG
%THEN %MESSAGE JUMP PLM Finished at '$DATETIME'
%FILE SELECT 1
%FILE WRITE ADD WELD_WINDOW
%LET O_WIND_ON = Y
%FILE WRITE TOGGLE ON OVER_WINDOW
%FILE WRITE REMOVE LOCK
%TEST L = 0
%ABOR FALSE
%THEN FILE WRIT LIST ADD "    NO PLM DATA FOUND WITHIN 'UT_RANGE metres of SELECTION  " " " PLM_DISP
%THEN FILE WRIT LIST ADD "    Use PLM Summary option in SHOW to check the PLM data range" " " PLM_DISP
%ENDM
%MACR _UT_JUMP_INIT
%FILE SELECT 1
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "****OOOOOOOOO**LLL*********II***GGGGGGGG***************" " " PLM_DISP
%FILE WRITE LIST ADD "****OOOOOOOOO**LL**********II**GGGGGGGG****************" " " PLM_DISP
%FILE WRITE LIST ADD "****OO*****OO**LL**********II**GG**********************" " " PLM_DISP
%FILE WRITE LIST ADD "****OO*****OO**LL**********II**GG**********************" " " PLM_DISP
%FILE WRITE LIST ADD "****OO*****OO**LL**********II**GG**********************" " " PLM_DISP
%FILE WRITE LIST ADD "****OO*****OO**LL*******L**II**GG**********************" " " PLM_DISP
%FILE WRITE LIST ADD "****OOOOOOOOO**LLLLLLLLLL**II***GGGGGGG****************" " " PLM_DISP
%FILE WRITE LIST ADD "****OOOOOOOOO**LLLLLLLLLL**II****GGGGGGG***************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE LIST ADD "*******************************************************" " " PLM_DISP
%FILE WRITE ADD WELD_WINDOW
%WAIT 1
%FILE WRITE REMOVE WELD_WINDOW
%ENDM
%MACR _UT_JUMP_TIE
%FILE SELECT 1
%TEST AP_TIE = 1
%JFAL .DEF
%TEST UT_UPWE = 0
%JTRU .END
%LET TI_WELD = 'UT_ORWE
%LET UT_TN = 'UT_TAPE
%FILE WRITE TEXT VALUE "'TI_WELD'" TXT_TIE_PARA
%FILE WRITE TEXT VALUE "'UT_TN'" TXT_TIE_PARB
.DEF:
%FILE SELECT 1
%TEST AP_DEF = 1
%JFAL .END
%TEST UT_UPWE = 0
%JTRU .END
%LET DEF_WELD = 'UT_ORWE
%LET DEF_TN = 'UT_TAPE
%FILE WRITE TEXT VALUE "'DEF_WELD'" TXT_DEF_PARA
%FILE WRITE TEXT VALUE "'DEF_TN'" TXT_DEF_PARB
.END:
%ENDM
%MACR _PLM_SIG
_O_DB_TRANS ROLLBACK "READ WRITE"
%ROUT 101 10 UPDATE WELD_TABLE_'O_PIPE_ID'
%ROUT 101 10 SET UPD_ABS_DIST = (UPD_ABS_DIST + 'UT_PLM_SIG')
%ROUT 101 10 WHERE FTR_ID = 'UT_FTID' AND FTR_TYPE = 1;
_O_CHECK_STATUS  "Error incrementing feature distance"
%ROUT 101 5 COMMIT
%ENDM
%MACR _UT_JUMP_HLT
%LET UT_FTTYPE = '$P1'
%LET _REAL6 = '$P2'
%LET UT_FTID = '$P3'
%LET UT_TAPE = '$P4'
%LET UT_ORWE = '$P5'
%LET UT_UPWE = '$P6'
%LET UT_FTC = '$P7'
%LET UT_FTREL = '$P8'
%LET UT_ABS = '$P9'
%LET UT_PREVIOUS_ABS = '$P10'
%LET UT_STACK = '$P11'
%LET UT_ORIG_DIST = '$P12'
%LET UT_NEXT_UPD = '$P13'
%LET UT_NEXT_UPW = '$P14'
%TEST UT_FTTYPE <> 1
%JTRU _UT_JUMP_TIE
%ENDM
